#!/bin/bash
set -e

echo 'NCH Arch Installer (post-install config.)'
read -p '[Press any key to continue]'
# 3.3: Timezone
echo "Timezone config..."
ln -sf /usr/share/zoneinfo/America/Mexico_City /etc/localtime
hwclock --systohc
# 3.4: Localization
echo "Localization config..."
cp /etc/locale.gen /etc/locale.gen.backup
## Default
echo '# Generated by NCH install script. Backup file: /etc/locale.gen.backup' > /etc/locale.gen
echo en_US.UTF-8 UTF-8 >> /etc/locale.gen
## MX spanish
echo es_MX.UTF-8 UTF-8 >> /etc/locale.gen
## Generate locales
locale-gen
## LANG (MX spanish)
echo "Setting lang: es_MX.UTF-8"
echo LANG=es_MX.UTF-8 > /etc/locale.conf
## Keyboard Layout
echo "Setting tty key layout: la-latin1"
echo KEYMAP=la-latin1 > /etc/vconsole.conf
# 3.5: Network
echo "Network config..."
read -p "Enter system hostname: " HOSTNAME_INPUT
echo $HOSTNAME_INPUT > /etc/hostname
# 3.7: Root password
echo "Set root password: "
passwd
# 3.8: Bootloader
echo "Bootloader config..."
bootctl install
##
echo "Setting up zen kernel:"
echo "default arch-zen.conf
timeout 1
console-mode max
editor no" > /boot/loader/loader.conf
##
# Getting UUID
ROOT_UUID=$(blkid -s UUID -o value $(df --output=source $(pwd) | tail -n 1))

cp encrypt_resources/arch-zen.conf /boot/loader/entries/
echo "cryptdevice=UUID=${ROOT_UUID}:root root=/dev/mapper/root rw" >> /boot/loader/entries/arch-zen.conf

cp encrypt_resources/arch-zen-fallback.conf /boot/loader/entries/arch-zen-fallback.conf
echo "cryptdevice=UUID=${ROOT_UUID}:root root=/dev/mapper/root rw" >> /boot/loader/entries/arch-zen-fallback.conf

echo "Exit, unmount & reboot. Then execute next script"
